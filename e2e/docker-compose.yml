version: '2.4'
services:
    teraslice-master:
        image: e2e_teraslice
        ports:
            - '45678:45678'
        scale: 1
        restart: 'on-failure'
        stop_grace_period: 30s
        environment:
            - TERAFOUNDATION_CONFIG=/app/config/teraslice-master.json
            - NODE_OPTIONS=--max-old-space-size=256
        external_links:
            - ts_test_kafka:kafka
            - ts_test_elasticsearch:elasticsearch
        networks:
            - cluster
            - ts_test
        volumes:
            - teraslice-assets:/app/assets
            - ./autoload:/app/autoload:delegated
            - ./.config:/app/config
    teraslice-worker:
        image: e2e_teraslice
        command: [
            "./scripts/wait-for-host.sh",
            "teraslice-master:45678",
            "node",
            "service.js"
        ]
        scale: 2
        restart: 'on-failure'
        stop_grace_period: 30s
        environment:
            - TERAFOUNDATION_CONFIG=/app/config/teraslice-worker.json
            - NODE_OPTIONS=--max-old-space-size=256
        external_links:
            - ts_test_kafka:kafka
            - ts_test_elasticsearch:elasticsearch
        networks:
            - cluster
            - ts_test
        volumes:
            - teraslice-assets:/app/assets
            - ./autoload:/app/autoload:delegated
            - ./.config:/app/config

volumes:
    teraslice-assets:
        driver_opts:
            type: tmpfs
            device: tmpfs
networks:
    cluster:
    ts_test:
        external: true
