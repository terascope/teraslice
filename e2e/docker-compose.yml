version: '2.4'
services:
    teraslice-master:
        image: e2e_teraslice
        command: [
            "./scripts/wait-for-it.sh",
            "elasticsearch:49200",
            "--timeout=60",
            "--",
            "node",
            "service.js"
        ]
        ports:
            - '45678:45678'
        scale: 1
        restart: 'on-failure'
        stop_grace_period: 30s
        environment:
            - TERAFOUNDATION_CONFIG=/app/config/teraslice-master.json
            - NODE_OPTIONS=--max-old-space-size=256
        networks:
            - cluster
        volumes:
            - teraslice-assets:/app/assets
            - ./autoload:/app/autoload:delegated
            - ./.config:/app/config:delegated
    teraslice-worker:
        image: e2e_teraslice
        command: [
            "./scripts/wait-for-it.sh",
            "elasticsearch:49200",
            "--timeout=75",
            "--",
            "node",
            "service.js"
        ]
        scale: 2
        restart: 'on-failure'
        stop_grace_period: 30s
        environment:
            - TERAFOUNDATION_CONFIG=/app/config/teraslice-worker.json
            - NODE_OPTIONS=--max-old-space-size=256
        networks:
            - cluster
        volumes:
            - teraslice-assets:/app/assets
            - ./autoload:/app/autoload:delegated
            - ./.config:/app/config:delegated
volumes:
    teraslice-assets:
        driver_opts:
            type: tmpfs
            device: tmpfs
networks:
    cluster:
